# Workflow simplifiÃ© pour construire et publier les artefacts
name: publish-artifacts

on:
  push:
    branches:
      - main
      - release-*
  workflow_dispatch:
    inputs:
      push_images:
        description: 'Push ne images to the registry'
        required: false
        default: 'true'
        type: boolean

permissions: read-all

env:
  # renovate: datasource=golang-version depName=golang versioning=loose
  GOLANG_VERSION: "1.25.5"
  OPERATOR_IMAGE_NAME: "ghcr.io/${{ github.repository }}-testing"
  REGISTRY: "ghcr.io"
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
  PLATFORMS: "linux/amd64,linux/arm64"
  BUILD_MANAGER_RELEASE_ARGS: "build --skip=validate --clean --id manager"

defaults:
  run:
    shell: 'bash -Eeuo pipefail -x {0}'

jobs:
  build-and-publish:
    name: Build and publish artifacts
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      controller_img: ${{ env.CONTROLLER_IMG }}
      controller_img_digest: ${{ fromJSON(steps.bake-push.outputs.metadata)['distroless']['containerimage.digest'] }}
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6
        with:
          go-version: ${{ env.GOLANG_VERSION }}
          check-latest: true

      - name: Build meta
        id: build-meta
        run: |
          commit_sha=${{ github.sha }}
          commit_date=$(git log -1 --pretty=format:'%ad' --date short "${commit_sha}" || :)
          commit_version=$(git describe --tags --match 'v*' "${commit_sha}" | sed -e 's/^v//; s/-g[0-9a-f]\+$//; s/-\([0-9]\+\)$/-dev\1/')
          commit_short=$(git rev-parse --short "${commit_sha}")
          branch_name=${GITHUB_REF#refs/heads/}
          tag_name=$(echo "$branch_name" | tr / -)

          echo "DATE=${commit_date}" >> $GITHUB_ENV
          echo "VERSION=${commit_version}" >> $GITHUB_ENV
          echo "COMMIT=${commit_short}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${tag_name,,}" >> $GITHUB_ENV
          echo "REPO_OWNER=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Set GoReleaser environment
        run: |
          echo GOPATH=$(go env GOPATH) >> $GITHUB_ENV
          echo PWD=$(pwd) >> $GITHUB_ENV

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6
        with:
          distribution: goreleaser
          version: v2
          args: ${{ env.BUILD_MANAGER_RELEASE_ARGS }}
        env:
          DATE: ${{ env.DATE }}
          COMMIT: ${{ env.COMMIT }}
          VERSION: ${{ env.VERSION }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
        with:
          platforms: ${{ env.PLATFORMS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Login into docker registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Build and push
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        id: bake-push
        env:
          environment: "testing"
          buildVersion: ${{ env.VERSION }}
          tag: ${{ env.IMAGE_TAG }}
          registry: ${{ env.REGISTRY }}/${{ env.REPO_OWNER }}
          revision: ${{ env.COMMIT }}
        with:
          source: .
          push: ${{ github.event.inputs.push_images != 'false' }}
          no-cache: true
          targets: "default"

      - name: Install cosign
        uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac # v3

      - name: Sign images
        if: ${{ github.event.inputs.push_images != 'false' }}
        run: |
          images=$(echo '${{ steps.bake-push.outputs.metadata }}' |
            jq -r '.[] | (."image.name" | sub(",.*";"" )) + "@" + ."containerimage.digest"'
          )
          cosign sign --yes ${images}

      - name: Output images
        env:
          DISTROLESS: ${{ fromJSON(steps.bake-push.outputs.metadata)['distroless']['image.name'] }}
          UBI: ${{ fromJSON(steps.bake-push.outputs.metadata)['ubi']['image.name'] }}
        run: |
          echo "CONTROLLER_IMG=${DISTROLESS}" >> $GITHUB_ENV
          echo "CONTROLLER_IMG_UBI=${UBI}" >> $GITHUB_ENV

      - name: Generate manifest for operator deployment
        env:
          CONTROLLER_IMG: ${{ env.CONTROLLER_IMG }}
          CONTROLLER_IMG_DIGEST: ${{ fromJSON(steps.bake-push.outputs.metadata)['distroless']['containerimage.digest'] }}
        run: |
          make generate-manifest

      - name: Upload operator manifest as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: operator-manifest.yaml
          path: dist/operator-manifest.yaml
          retention-days: 30

      - name: Upload GoReleaser dist as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: goreleaser-dist
          path: dist/
          retention-days: 30
